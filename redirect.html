<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Redirecting...</title>
  <meta name="description" content="" id="page-description">
  <meta name="keywords" content="" id="page-keywords">
  <meta name="author" content="" id="page-author">
  <meta property="og:title" content="" id="og-title">
  <meta property="og:description" content="" id="og-description">
  <meta property="og:image" content="" id="og-image">
  <meta property="og:url" content="" id="og-url">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="" id="twitter-title">
  <meta name="twitter:description" content="" id="twitter-description">
  <meta name="twitter:image" content="" id="twitter-image">
  <link rel="canonical" href="" id="canonical-link">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .redirect-container {
      text-align: center;
      max-width: 600px;
      padding: 2rem;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .redirect-info {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 2rem;
      margin-top: 2rem;
    }
    
    .redirect-info h2 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    
    .redirect-info p {
      margin-bottom: 1rem;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    .redirect-info img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    .manual-redirect {
      margin-top: 2rem;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    
    .error-message {
      background: rgba(239, 68, 68, 0.2);
      border: 2px solid rgba(239, 68, 68, 0.5);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="redirect-container">
    <div class="spinner"></div>
    <h1>Redirecting...</h1>
    <p>Please wait while we redirect you to your destination.</p>
    
    <div id="redirect-info" class="redirect-info" style="display: none;">
      <h2 id="info-title"></h2>
      <p id="info-description"></p>
      <img id="info-image" style="display: none;" alt="">
      <div class="manual-redirect">
        <p>If you're not redirected automatically, click the button below:</p>
        <a id="manual-link" href="#" class="btn">Continue to Destination</a>
      </div>
    </div>
    
    <div id="error-message" class="error-message" style="display: none;">
      <h2>Redirect Not Found</h2>
      <p>The requested redirect could not be found. Please check the URL and try again.</p>
      <div class="manual-redirect">
        <a href="/" class="btn">Go to Homepage</a>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCkOR3z8emuYMJ-lRZzaskXcYZ3GC657jA",
      authDomain: "lazada-finds.firebaseapp.com",
      projectId: "lazada-finds",
      storageBucket: "lazada-finds.firebasestorage.app",
      messagingSenderId: "332344238384",
      appId: "1:332344238384:web:0f8b0f595b62127410a8f5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get URL parameters or slug
    function getRedirectInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      const pathSegments = window.location.pathname.split('/').filter(segment => segment);
      
      // Check if it's a URL parameter redirect (u?title=...)
      if (urlParams.has('title')) {
        return {
          type: 'params',
          title: urlParams.get('title') || '',
          url: urlParams.get('url') || '',
          description: urlParams.get('description') || '',
          image: urlParams.get('image') || '',
          canonical: urlParams.get('canonical') || '',
          keywords: urlParams.get('keywords') || '',
          author: urlParams.get('author') || ''
        };
      }
      
      // Check if it's a slug redirect
      if (pathSegments.length > 0) {
        return {
          type: 'slug',
          slug: pathSegments[0]
        };
      }
      
      return null;
    }

    // Update meta tags
    function updateMetaTags(data) {
      document.getElementById('page-title').textContent = data.title || 'Redirecting...';
      document.title = data.title || 'Redirecting...';
      
      if (data.description) {
        document.getElementById('page-description').setAttribute('content', data.description);
        document.getElementById('og-description').setAttribute('content', data.description);
        document.getElementById('twitter-description').setAttribute('content', data.description);
      }
      
      if (data.keywords) {
        document.getElementById('page-keywords').setAttribute('content', data.keywords);
      }
      
      if (data.author) {
        document.getElementById('page-author').setAttribute('content', data.author);
      }
      
      if (data.title) {
        document.getElementById('og-title').setAttribute('content', data.title);
        document.getElementById('twitter-title').setAttribute('content', data.title);
      }
      
      if (data.image) {
        document.getElementById('og-image').setAttribute('content', data.image);
        document.getElementById('twitter-image').setAttribute('content', data.image);
      }
      
      if (data.canonical) {
        document.getElementById('canonical-link').setAttribute('href', data.canonical);
      }
      
      document.getElementById('og-url').setAttribute('content', window.location.href);
    }

    // Show redirect info
    function showRedirectInfo(data) {
      const infoDiv = document.getElementById('redirect-info');
      const titleEl = document.getElementById('info-title');
      const descEl = document.getElementById('info-description');
      const imageEl = document.getElementById('info-image');
      const linkEl = document.getElementById('manual-link');
      
      titleEl.textContent = data.title || 'Redirecting...';
      descEl.textContent = data.description || 'You will be redirected shortly.';
      
      if (data.image) {
        imageEl.src = data.image;
        imageEl.style.display = 'block';
      }
      
      linkEl.href = data.url;
      infoDiv.style.display = 'block';
    }

    // Show error
    function showError() {
      document.getElementById('error-message').style.display = 'block';
      document.querySelector('.spinner').style.display = 'none';
      document.querySelector('h1').textContent = 'Redirect Not Found';
    }

    // Perform redirect
    function performRedirect(url, delay = 3000) {
      setTimeout(() => {
        window.location.href = url;
      }, delay);
    }

    // Update click count
    async function updateClickCount(slug) {
      try {
        const docRef = db.collection('redirects').doc(slug);
        await docRef.update({
          clicks: firebase.firestore.FieldValue.increment(1),
          lastClicked: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error updating click count:', error);
      }
    }

    // Main redirect logic
    async function handleRedirect() {
      const redirectInfo = getRedirectInfo();
      
      if (!redirectInfo) {
        showError();
        return;
      }
      
      if (redirectInfo.type === 'params') {
        // Handle URL parameter redirect
        if (!redirectInfo.url) {
          showError();
          return;
        }
        
        updateMetaTags(redirectInfo);
        showRedirectInfo(redirectInfo);
        performRedirect(redirectInfo.url);
        
      } else if (redirectInfo.type === 'slug') {
        // Handle slug redirect
        try {
          const doc = await db.collection('redirects').doc(redirectInfo.slug).get();
          
          if (!doc.exists) {
            showError();
            return;
          }
          
          const data = doc.data();
          updateMetaTags(data);
          showRedirectInfo(data);
          updateClickCount(redirectInfo.slug);
          performRedirect(data.url);
          
        } catch (error) {
          console.error('Error fetching redirect:', error);
          showError();
        }
      }
    }

    // Initialize redirect
    handleRedirect();
  </script>
</body>
</html>